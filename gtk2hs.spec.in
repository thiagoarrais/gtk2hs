# RPM spec file for Gtk2HS   -*-rpm-spec-*-
#
# Copyright [2001..2002] Manuel M T Chakravarty <chak@cse.unsw.edu.au>
# Copyright 2002, 2003, 2004 Jens-Ulrik Holger Petersen <petersen@haskell.org>

%define ghc_version 6.2.1
%define ghcver 621

Summary: Haskell binding for the GIMP Toolkit (GTK2), a GUI library
Name: gtk2hs
Version: @VERSION@
Release: 0.%(date +%%Y%%m%%d)
Epoch: 0
License: LGPL
Group: Development/Libraries
Source: gtk2hs-%{version}.tar.gz
URL: http://gtk2hs.sourceforge.net/
BuildRoot: /var/tmp/gtk2hs-%{version}-root
BuildRequires: ghc = %{ghc_version}, %{_bindir}/hsc2hs, haddock, %{?_with_c2hs: c2hs >= 0.10.6}
BuildRequires: gtk2-devel, gtksourceview-devel, libglade2-devel, GConf2-devel

%description
A Gtk2 binding for the functional language Haskell featuring
automatic memory management, unicode support, and quite wide
coverage of widget functions and their signals, including
the new text and list widgets.  The convenience wrapper
MoGuL (Monad Gui Library) makes it possible to create and
lookup named widgets in a type safe way.

%package ghc%{ghcver}
Summary: Haskell binding for the GIMP Toolkit (GTK2), a GUI library
Group: Development/Languages/Haskell
Requires: ghc = %{ghc_version}
Requires: gtk2-devel
Requires(post,preun): %{_bindir}/ghc-pkg-%{ghc_version}

%description ghc%{ghcver}
A Gtk2 binding for the functional language Haskell featuring
automatic memory management, unicode support, and quite wide
coverage of widget functions and their signals, including
the new text and list widgets.  The convenience wrapper
MoGuL (Monad Gui Library) makes it possible to create and
lookup named widgets in a type safe way.

This package contains the libraries compiled for ghc-%{ghc_version}.

%package sourceview-ghc%{ghcver}
Summary: Haskell binding for gtksourceview
Group: Development/Languages/Haskell
Requires: ghc = %{ghc_version}
Requires: gtk2hs-ghc%{ghcver} = %{version}-%{release}, gtksourceview-devel
Requires(post,preun): %{_bindir}/ghc-pkg-%{ghc_version}

%description sourceview-ghc%{ghcver}
A GConf binding for gtk2hs.

This package is compiled for ghc-%{ghc_version}.

%package gconf-ghc%{ghcver}
Summary: Haskell binding for GConf
Group: Development/Languages/Haskell
Requires: ghc = %{ghc_version}
Requires: gtk2hs-ghc%{ghcver} = %{version}-%{release}, GConf-devel
Requires(post,preun): %{_bindir}/ghc-pkg-%{ghc_version}

%description gconf-ghc%{ghcver}
A GConf binding for gtk2hs.

This package is compiled for ghc-%{ghc_version}.

%package glade-ghc%{ghcver}
Summary: Haskell binding of glade for gtk2hs.
Group: Development/Languages/Haskell
Requires: ghc = %{ghc_version}
Requires: libglade2-devel
Requires(post,preun): %{_bindir}/ghc-pkg-%{ghc_version}

%description glade-ghc%{ghcver}
A Glade2 binding for gtk2hs.

This package is compiled for ghc-%{ghc_version}.

%package doc
Summary: Haskell binding for the GIMP Toolkit (GTK2), a GUI library
Group: Development/Languages/Haskell

%description doc
A Gtk2 binding for the functional language Haskell featuring
automatic memory management, unicode support, and quite wide
coverage of widget functions and their signals, including
the new text and list widgets.  The convenience wrapper
MoGuL (Monad Gui Library) makes it possible to create and
lookup named widgets in a type safe way.

This package contains the gtk2hs documentation.

# the debuginfo subpackage is currently empty anyway, so don't generate it
%define debug_package %{nil}
%define __spec_install_post /usr/lib/rpm/brp-compress

%define ghclibdir %{_libdir}/ghc-%{ghc_version}
%define gtk2hsdir %{ghclibdir}/gtk2hs

%prep
%setup -q

%build
./configure %{?c2hs: --with-c2hs=%{c2hs}} --with-hc=ghc-%{ghc_version} --with-hcflags="-O" --enable-sourceview --enable-libglade --with-ghc-docdir=%{_datadir}/doc/ghc-doc-%{ghc_version} --prefix=%{_prefix} --libdir=%{ghclibdir}

LANG=C make all html

%install
rm -rf %{buildroot}
make DESTDIR=%{buildroot} install-without-pkg install-html

mkdir -p %{buildroot}%{_datadir}/gtksourceview-1.0/language-specs
cp -p demo/sourceview/haskell.lang %{buildroot}%{_datadir}/gtksourceview-1.0/language-specs

# clean demo dirs
find -type f \( -name "*.hi" -o -name "*.o" -o -exec test -x '{}' ';' \) -exec rm '{}' ';'

%clean
rm -rf %{buildroot}

%post ghc%{ghcver}
ghc-pkg-%{ghc_version} -u -g -i %{gtk2hsdir}/gtk2/gtk2.conf
ghc-pkg-%{ghc_version} -u -g -i %{gtk2hsdir}/mogul/mogul.conf

%post sourceview-ghc%{ghcver}
ghc-pkg-%{ghc_version} -u -g -i %{gtk2hsdir}/sourceview/sourceview.conf

%post gconf-ghc%{ghcver}
ghc-pkg-%{ghc_version} -u -g -i %{gtk2hsdir}/gconf/gconf.conf

%post glade-ghc%{ghcver}
ghc-pkg-%{ghc_version} -u -g -i %{gtk2hsdir}/glade/glade.conf

%preun ghc%{ghcver}
if [ "$1" = 0 ]; then
  rm -f %{gtk2hsdir}/{gtk2/gtk2hs,mogul/mogul}.o
  ghc-pkg-%{ghc_version} -r mogul || :
  ghc-pkg-%{ghc_version} -r gtk2 || :
fi

%preun sourceview-ghc%{ghcver}
if [ "$1" = 0 ]; then
  rm -f %{gtk2hsdir}/sourceview/sourceview.o
  ghc-pkg-%{ghc_version} -r sourceview || :
fi

%preun gconf-ghc%{ghcver}
if [ "$1" = 0 ]; then
  rm -f %{gtk2hsdir}/gconf/gconf.o
  ghc-pkg-%{ghc_version} -r gconf || :
fi

%preun glade-ghc%{ghcver}
if [ "$1" = 0 ]; then
  rm -f %{gtk2hsdir}/glade/glade.o
  ghc-pkg-%{ghc_version} -r glade || :
fi

%files ghc%{ghcver}
%defattr(-,root,root) 
%dir %{gtk2hsdir}
%{gtk2hsdir}/gtk2
%{gtk2hsdir}/mogul
%doc ChangeLog TODO AUTHORS COPYING.LIB

%files sourceview-ghc%{ghcver}
%defattr(-,root,root) 
%{gtk2hsdir}/sourceview
%{_datadir}/gtksourceview-1.0/language-specs

%files gconf-ghc%{ghcver}
%defattr(-,root,root) 
%{gtk2hsdir}/gconf

%files glade-ghc%{ghcver}
%defattr(-,root,root) 
%{gtk2hsdir}/glade

%files doc
%defattr(-,root,root) 
%doc demo
%{_datadir}/doc/gtk2hs

%changelog
* Mon Aug 16 2004 Jens Petersen <petersen@haskell.org> - 0:0.9.6-0.fdr.1
- 0.9.6

* Thu Jul 22 2004 Jens Petersen <petersen@haskell.org>
- split sourceview and glade into separate subpackages
- require -devel packages rather than lib pkg for gtk2, gtksourceview,
  and libglade2

* Wed Mar 24 2004 Jens Petersen <petersen@haskell.org>
- enable gtksourceview and glade configure options
- use mkdir -p instead of mkdirhier
- update file locations in %%post and %%preun scripts
- buildrequire libglade2-devel

* Tue Nov 11 2003 Jens Petersen <petersen@haskell.org>
- use %%c2hs instead of "--with c2hs" to configure c2hs program
- clean demo to avoid binary files in docs dir

* Mon Nov  3 2003 Jens Petersen <petersen@haskell.org>
- add sourceview package to %%post and %%preun
- install gtksourceview haskell.lang language-spec

* Thu Jul 31 2003 Jens Petersen <petersen@haskell.org>
- build with ghc-6.0.1
- put demo dir in docs dir rather than individual source files

* Thu Jul 10 2003 Jens Petersen <petersen@haskell.org>
- build with ghc-6.0
- name ghc subpackage "ghc%%{ghc_version}"

* Wed Jun 18 2003 Jens Petersen <petersen@haskell.org>
- require and buildrequire %{_bindir}/ghc-%%{ghc_version}

* Wed May 21 2003 Jens Petersen <petersen@haskell.org>
- add -g option to ghc-pkg -u so that ghci object gets generated
- delete them when uninstalling
- build and include mogul documentation

* Thu May 15 2003 Jens Petersen <petersen@haskell.org>
- use new DESTDIR make variable, so no longer need to fix config files in post
- remove buildroot before install
- build and include gtk docs

* Fri Jan 10 2003 Jens Petersen <petersen@haskell.org>
- made into .spec.in file
- let configure set the version
- update description
- introduce --with-c2hs rpmbuild option
- use perl to remove buildroot traces from package conf files
- simplify ghc-pkg update commands

* Tue Dec 17 2002 Jens Petersen <petersen@haskell.org>
- latest cvs with ghc 5.04.2

* Thu Sep 26 2002 Jens Petersen
- build with ghc-5.04.1

* Fri Aug  2 2002 Jens Petersen
- only include demo source in doc dir

* Fri Jul 26 2002 Jens Petersen
- build with ghc-5.04
- cvs update

* Wed Jul 10 2002 Jens Petersen
- my current branch

* Wed May  1 2002 Jens Petersen
- patch TreeViewColumn.chs to make it usable

* Tue Apr 23 2002 Jens Petersen
- 0.9.0
- update gtk2 and mogul ghc-pkg entries on upgrade

* Fri Apr 12 2002 Jens Petersen
- adapt for gtk2hs
- fix mk files for buildroot install
- post and postun scriptlets for pkg config

* Tue Mar 12 2002 Manuel Chakravarty
- require a specific Haskell compiler (namely, the one for which the packages 
  was compiled)

* Sat Feb 17 2001 Manuel Chakravarty
- derived from C->Haskell's .spec file
