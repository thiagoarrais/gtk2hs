; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

[Setup]
AppName=Gtk2Hs
AppVerName=Gtk2Hs @VERSION@
AppVersion=@VERSION@
DefaultDirName={pf}\Gtk2Hs

AppPublisher=Gtk2Hs
AppPublisherURL=http://haskell.org/gtk2hs/
AppSupportURL=http://haskell.org/gtk2hs/

OutputBaseFilename=gtk2hs-@VERSION@
Compression=lzma
SolidCompression=yes
; the following is required because of the conditionaly installed files are not counted
ExtraDiskSpaceRequired=11572926

[Files]
Source: "gtk2hs-@VERSION@-gtk-2.4\*"; DestDir: "{app}"; Check: UseWithGtkVersion('2.4'); Flags: ignoreversion recursesubdirs createallsubdirs; AfterInstall: AfterPkgInstall;
Source: "gtk2hs-@VERSION@-gtk-2.6\*"; DestDir: "{app}"; Check: UseWithGtkVersion('2.6'); Flags: ignoreversion recursesubdirs createallsubdirs; AfterInstall: AfterPkgInstall;

[Run]
Filename: "{code:ghcpkg}"; Parameters: "--update-package --input-file={app}\glib.pkg";  StatusMsg: "Registering glib package...";  Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--update-package --input-file={app}\gtk.pkg";   StatusMsg: "Registering gtk package...";   Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--update-package --input-file={app}\glade.pkg"; StatusMsg: "Registering glade package..."; Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--update-package --input-file={app}\mogul.pkg"; StatusMsg: "Registering mogul package..."; Flags: runhidden

[UninstallRun]
Filename: "{code:ghcpkg}"; Parameters: "--remove-package=mogul"; RunOnceId: "mogul"; Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--remove-package=glade"; RunOnceId: "glade"; Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--remove-package=gtk";   RunOnceId: "gtk";   Flags: runhidden
Filename: "{code:ghcpkg}"; Parameters: "--remove-package=glib";  RunOnceId: "glib";  Flags: runhidden

[Code]
var
  GhcInstallDir: String;
  GhcInstallVersion: String;
  
  GtkInstallDir: String;
  { The version of Gtk+ that is installed on the machine: }
  GtkInstallVersion: String;
  { The build of Gtk2Hs to install: }
  GtkVersionToInstall: String;
  
function ghcpkg(Param: String): String;
begin
  Result := AddBackslash(GhcInstallDir) + 'bin\ghc-pkg.exe';
end;

function gtkdir(Param: String): String;
begin
  Result := GtkInstallDir;
end;

function UseWithGtkVersion(Version: String): Boolean;
begin
  Result := Version = GtkVersionToInstall;
end;

{ exec a program and return its output }
function ExecOutput(const Filename, Params: String): String;
var
  TmpFile: String;
  ResultCode: Integer;
begin
  Result := '';
  TmpFile := GenerateUniqueName(ExpandConstant('{tmp}'), 'tmp');
  if Exec(ExpandConstant('{cmd}'), '/C ' + Filename + ' ' + Params + ' > ' + TmpFile,
     '', SW_HIDE, ewWaitUntilTerminated, ResultCode) then
    if ResultCode = 0 then
      if LoadStringFromFile(TmpFile, Result) then
      begin
        Result := Trim(Result);
        Log('ExecOutput: running ' + Filename + ' succeded with output: ' + Result);
      end
      else
        Log('ExecOutput: running ' + Filename + ' succeded, but the temp file was not created')
    else
      Log('ExecOutput: running ' + Filename + ' failed, code: ' + IntToStr(ResultCode))
  else
    { That's really odd, we should always be able to exec the command interpreter! }
    Log('ExecOutput: cannot exec command interpreter, code: ' + IntToStr(ResultCode) + ', message: ' + SysErrorMessage(ResultCode));
end;

function CheckGhcVersionIsOk(const Path: String; var Version: String):Boolean;
begin
  Version := ExecOutput(AddBackslash(Path) + 'bin\ghc.exe', '--numeric-version');
  GhcInstallVersion := Version;
  
  Result := Version = '6.2.2';
end;

function DetectValidGhcInstallation(): Boolean;
var
  HaveSomeGHCInstalled: Boolean;
  GHCVersion: String;

begin
  Result := False;

  { first check for ghc on the path, then look in the registry }
  
  begin
    GhcInstallDir := ExecOutput('ghc.exe', '--print-libdir');
    if GhcInstallDir <> '' then
    begin
      StringChange(GhcInstallDir, '/', '\');
      Log('DetectValidGhcInstallation: found ghc on %PATH% with libdir: ' + GhcInstallDir);
      HaveSomeGHCInstalled := True;
      Result := CheckGhcVersionIsOk(GhcInstallDir, GHCVersion);
    end;
  end;

  if (Result = False) and RegKeyExists(HKEY_CURRENT_USER, 'Software\Haskell\GHC') then
  begin
    Log('DetectValidGhcInstallation: found HKCU\Software\Haskell\GHC');
    HaveSomeGHCInstalled := True;
    RegQueryStringValue(HKEY_CURRENT_USER, 'Software\Haskell\GHC\ghc-6.2.2', 'InstallDir', GhcInstallDir);
    Result := CheckGhcVersionIsOk(GhcInstallDir, GHCVersion);
  end;

  if (Result = False) and RegKeyExists(HKEY_LOCAL_MACHINE, 'SOFTWARE\Haskell\GHC') then
  begin
    Log('DetectValidGhcInstallation: found HKLM\SOFTWARE\Haskell\GHC');
    HaveSomeGHCInstalled := True;
    RegQueryStringValue(HKEY_LOCAL_MACHINE, 'SOFTWARE\Haskell\GHC\ghc-6.2.2', 'InstallDir', GhcInstallDir);
    Result := CheckGhcVersionIsOk(GhcInstallDir, GHCVersion);
  end;
  
  if Result then
    Log('DetectValidGhcInstallation: correct version of ghc found at: ' + GhcInstallDir)
  else if HaveSomeGHCInstalled and (GHCVersion <> '') then
  begin
    Log('DetectValidGhcInstallation: incorrect ghc version installed: ' + GHCVersion);
    SuppressibleMsgBox('This version of Gtk2Hs requires GHC version 6.2.2.', mbError, MB_OK, IDOK);
  end
  else if HaveSomeGHCInstalled and (GhcInstallDir <> '') then
  begin
    Log('DetectValidGhcInstallation: some non-working version of ghc appears to be installed at: ' + GhcInstallDir);
    SuppressibleMsgBox('GHC does not appear to be installed correctly, try reinstalling GHC version 6.2.2.', mbError, MB_OK, IDOK);
  end
  else if HaveSomeGHCInstalled then
  begin
    Log('DetectValidGhcInstallation: corrupted ghc installation detected, probably messed up registry keys');
    SuppressibleMsgBox('GHC does not appear to be installed (or the installation is corrupted), please install GHC version 6.2.2.', mbError, MB_OK, IDOK);
  end
  else
  begin
    Log('DetectValidGhcInstallation: no installation of ghc detected');
    SuppressibleMsgBox('Gtk2Hs requires GHC to be installed first, please install GHC version 6.2.2.', mbError, MB_OK, IDOK);
  end;

end;

procedure ParseVersionString(Version: String; var MajorVersion, MinorVersion, MicroVersion: Integer);
var
  N, M : Integer;
  MajorVersionStr, MinorVersionStr, MicroVersionStr: String;
begin
  N := 1;
  M := 1;
  SetLength(MajorVersionStr, Length(Version));
  while (N < Length(Version) + 1) and (Version[N] >= '0') and (Version[N] <= '9') do
  begin
    MajorVersionStr[M] := Version[N];
    N := N + 1; M := M + 1;
  end;
  SetLength(MajorVersionStr, M - 1);

  while (N < Length(Version) + 1) and ((Version[N] < '0') or (Version[N] > '9')) do
    N := N + 1;

  M := 1;
  SetLength(MinorVersionStr, Length(Version));
  while (N < Length(Version) + 1) and (Version[N] >= '0') and (Version[N] <= '9') do
  begin
    MinorVersionStr[M] := Version[N];
    N := N + 1; M := M + 1;
  end;
  SetLength(MinorVersionStr, M - 1);

  while (N < Length(Version) + 1) and ((Version[N] < '0') or (Version[N] > '9')) do
    N := N + 1;

  M := 1;
  SetLength(MicroVersionStr, Length(Version));
  while (N < Length(Version) + 1) and (Version[N] >= '0') and (Version[N] <= '9') do
  begin
    MicroVersionStr[M] := Version[N];
    N := N + 1; M := M + 1;
  end;
  SetLength(MicroVersionStr, M - 1);
  
  MajorVersion := StrToIntDef(MajorVersionStr, 0);
  MinorVersion := StrToIntDef(MinorVersionStr, 0);
  MicroVersion := StrToIntDef(MicroVersionStr, 0);

  Log('ParseVersionString: Version = ' + Version);
  Log('ParseVersionString: MajorVersion = ' + IntToStr(MajorVersion));
  Log('ParseVersionString: MinorVersion = ' + IntToStr(MinorVersion));
  Log('ParseVersionString: MicroVersion = ' + IntToStr(MicroVersion));
end;

function CheckGtkVersionIsOk(const Path: String; var Version: String):Boolean;
var
  MajorVersion, MinorVersion, MicroVersion: Integer;
begin
  GetVersionNumbersString(AddBackslash(Path) + 'bin\libgtk-win32-2.0-0.dll', Version);
  ParseVersionString(Version, MajorVersion, MinorVersion, MicroVersion);

  Result := (MajorVersion = 2)
        and (MinorVersion >= 4);

  GtkInstallVersion := IntToStr(MajorVersion)
               + '.' + IntToStr(MinorVersion)
               + '.' + IntToStr(MicroVersion);
               
  if MinorVersion = 4 then
    GtkVersionToInstall := '2.4'
  else if MinorVersion >= 6 then
    GtkVersionToInstall := '2.6';
end;

type GtkStatus =
  (GtkNotDetected
  ,GtkAppearsToHaveBeenInstalledEver
  ,GtkAppearsToBeInstalled
  ,GtkVersionIsOk
  ,GtkDevelIsInstalled
  ,InstalledOk);

function DetectValidGtkInstallation(): Boolean;
var
  GtkVersion, GtkVendorVersion: String;
  GtkStatus : GtkStatus;
  RegHive: Integer;

  InstallMessage: String;
begin
  GtkStatus := GtkNotDetected;
  Result := False;

  if RegKeyExists(HKEY_CURRENT_USER, 'Software\GTK\2.0') then
  begin
    GtkStatus := GtkAppearsToHaveBeenInstalledEver;
    RegHive := HKEY_CURRENT_USER;
  end
  else if RegKeyExists(HKEY_LOCAL_MACHINE, 'Software\GTK\2.0') then
  begin
    GtkStatus := GtkAppearsToHaveBeenInstalledEver;
    RegHive := HKEY_LOCAL_MACHINE;
  end

  if (GtkStatus = GtkAppearsToHaveBeenInstalledEver)
    and RegQueryStringValue(RegHive, 'Software\GTK\2.0', 'Path', GtkInstallDir)
    and DirExists(GtkInstallDir) then
    GtkStatus := GtkAppearsToBeInstalled;

  if (GtkStatus = GtkAppearsToBeInstalled)
    and CheckGtkVersionIsOk(GtkInstallDir, GtkVersion) then
    GtkStatus := GtkVersionIsOk;

  if (GtkStatus = GtkVersionIsOk)
    and FileExists(AddBackslash(GtkInstallDir) + 'lib\libgtk-win32-2.0.dll.a')
    and FileExists(AddBackslash(GtkInstallDir) + 'include\gtk-2.0\gtk\gtk.h') then
    GtkStatus := GtkDevelIsInstalled;

  if (GtkStatus = GtkDevelIsInstalled)
    and (Pos(AddBackslash(GtkInstallDir) + 'bin', GetEnv('PATH')) <> 0) then
    GtkStatus := InstalledOk;

  case GtkStatus of
    GtkNotDetected:
      InstallMessage := 'Gtk2Hs requires Gtk+ to be installed first.' #13#10 #13#10
                        'Please install the Gtk+ Development Environment, which is available from' #13#10
                        'http://gladewin32.sourceforge.net/' #13#10 #13#10
                        'You need any "devel" version between 2.6.0 and 2.6.6 (not 2.6.7+)';
    GtkAppearsToHaveBeenInstalledEver:
      InstallMessage := 'The Gtk+ installation appears to be missing or currupted' #13#10 #13#10
                        'Please reinstall the Gtk+ Development Environment, which is available from' #13#10
                        'http://gladewin32.sourceforge.net/' #13#10 #13#10
                        'You need any "devel" version between 2.6.0 and 2.6.6 (not 2.6.7+)';
    GtkAppearsToBeInstalled:
      InstallMessage := 'The version of Gtk+ installed is too old' #13#10 #13#10
                        'Please install the Gtk+ Development Environment, which is available from' #13#10
                        'http://gladewin32.sourceforge.net/' #13#10 #13#10
                        'You need any "devel" version between 2.6.0 and 2.6.6 (not 2.6.7+)';
    GtkVersionIsOk:
    begin
      RegQueryStringValue(RegHive, 'Software\GTK\2.0', 'VendorVersion', GtkVendorVersion);
      if Pos('devel', GtkVendorVersion) = 0 then
      InstallMessage := 'Gtk2Hs requires the "devel" version of Gtk+ rather than the "runtime" version.' #13#10 #13#10
                        'Please install the Gtk+ Development Environment, which is available from' #13#10
                        'http://gladewin32.sourceforge.net/' #13#10 #13#10
                        'You need any "devel" version between 2.6.0 and 2.6.6 (not 2.6.7+)'
      else
      InstallMessage := 'Gtk2Hs requires the Gtk+ development headers and libraries to be installed.' #13#10 #13#10
                        'Please reinstall Gtk+ and make sure the "Devel headers/libraries" option is selected'
    end;
    GtkDevelIsInstalled:
      InstallMessage := 'The Gtk+ libraries are not on the Windows search path' #13#10
                        '(which would cause all Gtk2Hs programs not to work!).' #13#10 #13#10
                        'Please reinstall Gtk+ and make sure the "Register Environment variables" option is selected';
    InstalledOk:
      InstallMessage := 'Gtk seems to be installed correctly';
  end;

  if (GtkStatus = InstalledOk) and (CompareStr(GtkVersion, '2.6.7') >= 0) then
  begin
    InstallMessage := 'Sadly this release of Gtk2Hs has been found not to work with Gtk+ versions 2.6.7 and above' #13#10 #13#10
                      'Please reinstall the Gtk+ Development Environment, which is available from' #13#10
                      'http://gladewin32.sourceforge.net/' #13#10 #13#10
                      'You need any "devel" version between 2.6.0 and 2.6.6 (not 2.6.7+)'  #13#10  #13#10
                      'Alternatively, a later Gtk2Hs release should be ok';
    GtkStatus := GtkAppearsToBeInstalled;
  end;

  Log(InstallMessage);
  
  { fixme: check about the 2.6.7 problem and ban that version from being used }
  
  if GtkStatus = InstalledOk then
    Result := True
  else
    SuppressibleMsgBox(InstallMessage, mbError, MB_OK, IDOK);
end;

function NextButtonClick(CurPageID: Integer): Boolean;
begin
  if CurPageID = wpWelcome then
    Result := DetectValidGhcInstallation() and DetectValidGtkInstallation()
  else
    Result := True;
end;

procedure PackageFileVarSubstitute(const PackageFile: String);
var
  PackageFileContent: String;
  PackageLibDir: String;
  GtkBaseDir: String;
begin
  PackageLibDir := ExpandConstant('{app}');
  StringChange(PackageLibDir, '\', '/');
  
  GtkBaseDir := GtkInstallDir;
  StringChange(GtkBaseDir, '\', '/');

  LoadStringFromFile(PackageFile, PackageFileContent);

  StringChange(PackageFileContent, '${pkglibdir}', PackageLibDir);
  StringChange(PackageFileContent, '${GTK_BASEPATH}', GtkBaseDir);
  
  SaveStringToFile(PackageFile, PackageFileContent, False);
  Log('Expanding variables in ' + PackageFile);
end;

procedure AfterPkgInstall;
begin
  if (ExtractFileExt(CurrentFileName) = '.pkg')
  or (ExtractFileExt(CurrentFileName) = '.cabal') then
    PackageFileVarSubstitute(ExpandConstant(CurrentFileName));
end;

// Detect when the ready info page gets displayed
function UpdateReadyMemo(Space, NewLine, MemoUserInfoInfo, MemoDirInfo,
                         MemoTypeInfo, MemoComponentsInfo, MemoGroupInfo,
                         MemoTasksInfo: String): String;
begin
		Result := MemoDirInfo + NewLine
		        + NewLine
		        +	'Using GHC ' + GhcInstallVersion + ' installed at:' + NewLine
		        + Space + GhcInstallDir + NewLine
		        + NewLine
		        + 'Using Gtk+ ' + GtkInstallVersion + ' installed at:' + NewLine
		        + Space + GtkInstallDir;
end;

